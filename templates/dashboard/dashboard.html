{% extends 'dashboard/base.html' %}

{% block content %}
<section class="page-header">
  <div>
    <h2>메인 대시보드: 통합 관제</h2>
    <p>실시간 위기 대응과 미션 진행률을 한눈에 확인합니다.</p>
  </div>
  <div class="header-metrics">
    <div>
      <span>위험 단계</span>
      <strong>{{ red_alerts|length }}명</strong>
    </div>
    <div>
      <span>오늘 완료 미션</span>
      <strong>{{ mission_summary.completed }} / {{ mission_summary.total }}</strong>
    </div>
  </div>
</section>

<section class="grid two">
  <article class="card alert-card" data-animate>
    <div class="card-header">
      <h3>실시간 위기 현황</h3>
      <span class="chip danger">위험(RED)</span>
    </div>
    <ul class="alert-list">
      {% for person in red_alerts %}
      <li>
        <div>
          <strong>{{ person.name }}</strong>
          <p>{{ person.area }} · {{ person.age }}세 · {{ person.risk_reason }}</p>
        </div>
        <span class="timestamp">{{ person.last_event }}</span>
      </li>
      {% empty %}
      <li>
        <div>
          <strong>위험 상태 없음</strong>
          <p>현재 RED 단계 어르신이 없습니다.</p>
        </div>
        <span class="timestamp">-</span>
      </li>
      {% endfor %}
    </ul>
  </article>
  <article class="card" data-animate>
    <div class="card-header">
      <h3>오늘의 미션 현황</h3>
      <span class="chip">치매 예방 퀘스트</span>
    </div>
    <div class="chart-wrap">
      <canvas id="missionChart"></canvas>
      <div class="chart-center">
        <strong>{{ mission_summary.rate }}%</strong>
        <span>완료율</span>
      </div>
    </div>
    <div class="hint">
      <span>상위 완료 지역: {{ mission_summary.top_area }}</span>
      <span>지연 알림: {{ mission_summary.delayed }}명</span>
    </div>
  </article>
</section>

<section class="card" data-animate>
  <div class="card-header">
    <h3>지역별 통계</h3>
    <span class="chip">안전 상태</span>
  </div>
  <div class="chart-area">
    <canvas id="regionChart"></canvas>
  </div>
  <div class="legend">
    <span><i class="dot safe"></i> 안정</span>
    <span><i class="dot caution"></i> 주의</span>
    <span><i class="dot danger"></i> 위험</span>
  </div>
</section>

{{ region_chart|json_script:"region-chart" }}
{{ mission_chart|json_script:"mission-chart" }}
{% endblock %}

{% block script_extra %}
<script>
  const regionData = JSON.parse(document.getElementById('region-chart').textContent);
  const missionData = JSON.parse(document.getElementById('mission-chart').textContent);
  window.renderRegionChart('regionChart', regionData);
  window.renderMissionChart('missionChart', missionData);
</script>
{% endblock %}
